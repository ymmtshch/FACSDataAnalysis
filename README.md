# FACS Data Analysis
StreamlitベースのFACS（フローサイトメトリー）データ解析Webアプリケーション

## 📋 概要
FACS Data Analysisは、フローサイトメトリーデータ（FCSファイル）を解析するためのWebベースのアプリケーションです。研究者や技術者が直感的なインターフェースでデータを可視化・解析できるよう設計されています。日本語インターフェースを採用し、研究現場での使いやすさを重視しています。

## ✨ 主な機能

### アプリケーション構成
- **メインアプリケーション（app.py）**: 統合インターフェースとタブベース解析
- **基本解析ページ（pages/basic_analysis.py）**: 専用の基本解析インターフェース（独立動作）
- **高度解析ページ（pages/advanced_gating.py）**: 複雑なゲーティング機能（完全実装済み）

### データ処理
- **FCSファイル解析**: FCS 2.0、3.0、3.1形式の標準的なフローサイトメトリーファイルの読み込み
- **複数の読み込み方式**: 
  - メインアプリ: 統合処理パイプライン（utils/fcs_processor経由）
  - 基本解析ページ: 自動ライブラリ選択による最適化された読み込み
- **自動ライブラリ選択**: fcsparser → flowioの優先順位で最適なライブラリを自動選択
- **データ変換**: なし、Log10、Asinh、Biexponential変換に対応
- **イベント数制御**: パフォーマンス最適化のための最大イベント数設定（1,000～100,000）
- **リアルタイム処理**: アップロードから解析まで一連の流れをシームレスに実行

### ファイル情報表示
- **基本統計情報**: 総イベント数、パラメータ数、取得日時、使用機器情報
- **実験メタデータ**: 実験名、サンプルID、オペレーター、ソフトウェア情報
- **チャンネル詳細**: 各チャンネルの詳細情報と設定値
- **データプレビュー**: 最初の100行のデータ表示
- **デバッグ情報**: 使用ライブラリ、データ変換プロセスの詳細表示

### 可視化機能
- **多様なプロットタイプ**: 
  - 散布図: 2Dプロットでの相関解析
  - 密度プロット: 2Dヒストグラムベースの密度可視化
  - ヒストグラム: 単一チャンネルの分布表示
- **プロット設定**:
  - 透明度調整（散布図）
  - カスタマイズ可能なビン数（ヒストグラム）
  - 対数スケール表示オプション
- **パフォーマンス最適化**: 
  - サンプリング機能（1,000～100,000ポイント）
  - インタラクティブなPlotlyベースの可視化
- **チャンネル別表示**: X軸・Y軸の個別選択とリアルタイム更新

### ゲーティング機能
- **基本閾値ゲーティング**: 単一チャンネルでの閾値設定による簡易ゲーティング（メインアプリ）
- **高度ゲーティング機能**: advanced_gating.pyページで以下の機能を提供
  - **矩形ゲート**: 2次元での矩形領域選択
  - **ポリゴンゲート**: 任意の多角形領域での選択
  - **楕円ゲート**: 楕円形領域での選択
  - **閾値ゲート**: 単一パラメータでの閾値設定
  - **インタラクティブ可視化**: 密度プロットでのリアルタイムゲート表示
  - **詳細統計解析**: ゲート内データの包括的統計情報
  - **ゲート管理**: 複数ゲートの作成・削除・統計表示

### 統計解析・エクスポート
- **全チャンネル統計**: 平均値、中央値、標準偏差、最小値、最大値
- **包括的統計情報**: 処理済みデータの統計値をリアルタイム計算
- **データエクスポート**: 
  - 統計データのCSVダウンロード（自動命名：`{元ファイル名}_stats.csv`）
  - 表示データ（変換済み・サンプリング済み）のCSVエクスポート（自動命名：`{元ファイル名}_data.csv`）
  - 2段階エクスポート：ボタンクリック → ダウンロードボタン表示の直感的UI

## 🔧 システム要件
- Python 3.8以上
- Streamlit 1.28.0以上
- モダンWebブラウザ（Chrome、Firefox、Safari、Edge）

## 📦 依存関係
```
streamlit>=1.28.0
pandas>=2.0.0
numpy>=1.24.0
plotly>=5.15.0
fcsparser>=0.2.0
flowio
flowkit
bokeh>=3.2.0
scipy>=1.10.0
scikit-image>=0.21.0
shapely>=2.0.0
altair>=5.0.0
```

### FCSファイル読み込みライブラリ
アプリケーションは複数のFCS読み込みライブラリに対応し、自動的に最適なライブラリを選択します：

1. **fcsparser** (推奨・第一優先)
   - 長期間にわたり安定した実績
   - 豊富なメタデータ解析機能
   - 標準的なFCS形式に最適化

2. **flowio** (第二優先)
   - 高速なデータ処理性能
   - NumPy 2.0完全対応
   - モダンなデータ処理アーキテクチャ

3. **flowkit** (フォールバック)
   - 高度な解析機能を提供
   - 自動的なデータフレーム変換

**注意**: 様々なFCS形式への対応を考慮し、fcsparserを第一優先としていますが、NumPy 2.0環境で互換性問題が発生した場合は自動的にflowioにフォールバックします。

### 主要ライブラリの用途
- **streamlit**: Webアプリケーションフレームワーク
- **pandas/numpy**: データ処理・数値計算
- **plotly**: インタラクティブな可視化（メイン）
- **fcsparser/flowio/flowkit**: FCSファイル読み込み（自動選択）
- **scipy**: 科学計算・統計処理
- **bokeh/altair**: 補助的な可視化機能
- **scikit-image**: 画像処理（密度プロット等）
- **shapely**: 幾何学的計算（ゲーティング用）

### ユーティリティモジュール（必須）
```
utils/
├── fcs_processor.py     # FCSファイル処理クラス
├── plotting.py          # プロット作成機能（PlottingUtilsクラス）
└── gating.py           # ゲーティング機能（完全実装済み）
```

## 🚀 インストールと実行

### 推奨インストール手順
```bash
# 基本インストール
pip install streamlit pandas numpy plotly

# FCS読み込みライブラリ（推奨順）
pip install fcsparser      # 最優先
pip install flowio          # 代替
pip install flowkit         # フォールバック

# その他の依存関係
pip install scipy scikit-image shapely bokeh altair
```

### ローカル環境での実行
1. **リポジトリのクローン**
   ```bash
   git clone https://github.com/ymmtshch/FACSDataAnalysis.git
   cd FACSDataAnalysis
   ```

2. **仮想環境の作成**
   ```bash
   python -m venv venv
   source venv/bin/activate  # Windows: venv\Scripts\activate
   ```

3. **依存関係のインストール**
   ```bash
   pip install -r requirements.txt
   ```

4. **アプリケーションの実行**
   ```bash
   streamlit run app.py
   ```

### Streamlit Cloudでのデプロイ
1. GitHubリポジトリにコードをプッシュ
2. [Streamlit Cloud](https://streamlit.io/cloud)にアクセス
3. リポジトリを選択してデプロイ

## 📁 プロジェクト構造
```
facs-analysis-app/
├── app.py                    # メインアプリケーション
├── config.py                 # 設定ファイル
├── requirements.txt          # 依存関係
├── README.md                 # プロジェクト説明
├── .gitignore               # Git除外設定
├── .streamlit/
│   └── config.toml          # Streamlit設定
├── pages/
│   ├── basic_analysis.py    # 基本解析ページ（独立動作）
│   └── advanced_gating.py   # 高度ゲーティングページ（完全実装済み）
└── utils/
    ├── fcs_processor.py     # FCS処理ユーティリティ（必須）
    ├── plotting.py          # プロット作成機能（必須）
    └── gating.py            # ゲーティング機能（完全実装済み）
```

## 📖 使用方法

### 1. ファイルアップロード（共通）
- **メインアプリ**: 左サイドバーの「📁 ファイルアップロード」セクション
- **基本解析ページ**: 左サイドバーからの直接アップロード
- **高度ゲーティングページ**: 左サイドバーからの直接アップロード
- **対応形式**: 標準的なFCS 2.0/3.0/3.1形式ファイル

### 2. メインアプリケーション（app.py）
アプリケーションは4つのタブで構成されています：

#### 📊 基本情報タブ
- **ファイル情報**: 総イベント数、パラメータ数、取得日時などの基本情報
- **実験情報**: 実験名、サンプルID、オペレーター情報
- **チャンネル情報**: 各チャンネルの詳細設定
- **データプレビュー**: 最初の100行のデータ表示

#### 📈 可視化タブ
- **ヒストグラム**: 
  - チャンネル選択とビン数調整
  - 対数スケール表示オプション
- **散布図**: 
  - X軸・Y軸チャンネル選択
  - 透明度とサンプルサイズ調整
- **等高線プロット**: 
  - 2Dヒストグラムの密度可視化
  - 密度計算ビン数の調整

#### 🎯 ゲーティングタブ
- **基本閾値ゲーティング**: 
  - ゲートチャンネル選択
  - 閾値設定（デフォルト：中央値）
  - ゲート前後のイベント数とゲート率表示
- **高度ゲーティング**: advanced_gating.pyページへのリンク

#### 📋 統計解析タブ
- **全チャンネル統計**: 基本統計量の一覧表示
- **データエクスポート**: 
  - 統計データのCSVダウンロード（固定ファイル名：facs_statistics.csv）
  - 生データのCSVダウンロード（固定ファイル名：facs_raw_data.csv）

### 3. 基本解析ページ（pages/basic_analysis.py）
より詳細で柔軟な解析インターフェース：

#### 🔧 自動ライブラリ選択・デバッグ機能
- **ライブラリ自動検出**: 利用可能なFCS読み込みライブラリを自動選択
- **ライブラリ表示**: サイドバーで現在使用中のライブラリを表示
- **詳細デバッグ情報**: 
  - イベントデータタイプとチャンネル数
  - データ変換プロセスの詳細
  - チャンネル名一覧の表示オプション

#### 📊 強化されたファイル情報・メタデータ
- **3列メトリクス**: イベント数、パラメータ数、取得日の見やすい表示
- **詳細メタデータ表示**: 展開可能なセクションで以下を表示
  - **標準メタデータ**: `$TOT`, `$PAR`, `$DATE`, `$BTIM`, `$ETIM`, `$CYT`, `$CYTNUM`
  - **FlowKit互換**: 小文字キー（`tot`, `par`, `date`等）への自動対応
  - **全メタデータ表示**: オプションで全メタデータ項目の表示（最初の20項目）

#### 🎯 高精度チャンネル・変換設定
- **チャンネル名の自動取得**: 
  - `$P{n}N` (チャンネル名) → `$P{n}S` (ショート名) → デフォルト名の順で取得
  - 重複チャンネル名の自動リネーム（_2, _3等の付加）
- **個別変換設定**: X軸・Y軸それぞれに異なる変換を適用
  - 変換オプション: なし、Log10、Asinh、Biexponential
- **チャンネル選択**: 全パラメータから自由に選択

#### ⚡ 表示設定・パフォーマンス最適化
- **表示ポイント数**: 1,000～最大100,000（またはファイルサイズ上限）
- **プロットタイプ選択**: 散布図、密度プロット、ヒストグラム
- **スマートサンプリング**: 大容量データの自動サンプリング機能

#### 📈 多様な可視化オプション
- **散布図**: 標準的な2Dプロット
- **密度プロット**: 高密度領域の可視化
- **ヒストグラム**: X軸・Y軸の並列表示

#### 📊 リアルタイム統計解析
- **選択チャンネル統計**: 選択されたX・Y軸の詳細統計表示
- **変換後統計**: データ変換適用後の統計値
- **統計項目**: 平均、中央値、標準偏差、最小値、最大値

#### 💾 改良されたデータエクスポート
- **自動ファイル命名**: 
  - 統計情報: `{元ファイル名}_stats.csv`
  - 表示データ: `{元ファイル名}_data.csv`
- **2段階エクスポート**: ボタンクリック → ダウンロードボタン表示の直感的UI
- **統計情報CSV**: 計算された統計値のエクスポート
- **表示データCSV**: 変換・サンプリング済みデータのエクスポート

#### 🔍 包括的エラーハンドリング
- **ライブラリ固有エラー**: 
  - NumPy 2.0互換性問題の検出と対処法表示
  - データ変換失敗時の代替方法自動実行
- **詳細エラー情報**: 展開可能なエラー詳細表示
- **エラー耐性**: データ変換エラー時の代替処理実装

### 4. 高度ゲーティングページ（pages/advanced_gating.py）
専門的なゲーティング解析のための独立インターフェース：

#### 🎯 多様なゲートタイプ
- **矩形ゲート**: X・Y軸範囲指定による2次元領域選択
- **ポリゴンゲート**: カスタム座標入力による任意形状の領域選択
- **楕円ゲート**: 中心点・幅・高さ指定による楕円領域選択
- **閾値ゲート**: 単一チャンネルでの閾値設定（以上・以下・より大きい・より小さい）

#### 📊 インタラクティブ解析
- **密度プロット可視化**: 高密度領域の視覚的確認
- **リアルタイムゲート表示**: 設定したゲートの即座な可視化
- **複数ゲート管理**: 同時に複数のゲートを設定・管理

#### 📈 詳細統計解析
- **ゲート内統計**: 選択されたゲート内データの詳細統計情報
- **イベント数・割合**: ゲート効率の定量的評価
- **チャンネル別統計**: 平均値・中央値・標準偏差等の包括的統計
- **データエクスポート**: ゲート内データのCSV出力機能

#### 🔧 高度な機能
- **ゲート削除**: 個別ゲートの選択削除機能
- **ゲートクリア**: 全ゲートの一括削除機能
- **ゲート統計比較**: 複数ゲート間の統計比較
- **データ変換対応**: 各軸に対する個別データ変換適用

### 5. 高度な機能
- **カスタム可視化**: Plotlyベースのインタラクティブなプロット
- **並列処理**: 大容量ファイルの効率的な処理
- **セッション管理**: 複数ファイル・ゲートの状態保持

## ⚙️ 設定とカスタマイズ

### UI設定
アプリケーションのUIは以下の要素でカスタマイズされています：
- **カラーテーマ**: メインカラー（オレンジ #FF6B35）、背景色、テキスト色
- **レスポンシブデザイン**: ワイドレイアウトと拡張サイドバー
- **日本語インターフェース**: 完全日本語対応

### config.py設定
- アプリケーション固有の設定値
- デフォルトパラメータ
- ファイル処理制限

### .streamlit/config.toml
Streamlitアプリケーションの基本設定：
```toml
[server]
maxUploadSize = 100
enableCORS = false
enableXsrfProtection = true

[theme]
primaryColor = "#FF6B35"
backgroundColor = "#FFFFFF"
secondaryBackgroundColor = "#F0F2F6"
textColor = "#262730"
font = "sans serif"

[browser]
gatherUsageStats = false
```

## 🔧 開発・拡張

### 必須ユーティリティモジュール
以下のモジュールは正常動作に必要です：

#### utils/fcs_processor.py
```python
class FCSProcessor:
    def get_file_info(self) -> dict
    def get_channel_info(self) -> dict
    def get_basic_stats(self) -> dict
    def export_data(self, data) -> str
    def preprocess_data(self, data, meta) -> pd.DataFrame
    def apply_transform(self, data, transform_type) -> pd.Series

def load_and_process_fcs(file, transformation, max_events):
    # FCSファイル処理の主要関数
    return processor, data, metadata
```

#### utils/plotting.py
```python
class PlottingUtils:
    def create_scatter_plot(self, data, x_channel, y_channel, title="")
    def create_density_plot(self, data, x_channel, y_channel, title="")
    def create_histogram(self, data, channel, title="")

# 従来の関数ベースAPI（後方互換性）
def create_histogram(data, channel, bins=50)
def create_scatter_plot(data, x_channel, y_channel, alpha=0.6)
```

#### utils/gating.py（完全実装済み）
```python
class GateManager:
    def create_rectangular_gate(self, name, x_channel, y_channel, x_min, x_max, y_min, y_max)
    def create_polygon_gate(self, name, x_channel, y_channel, coordinates)
    def create_ellipse_gate(self, name, x_channel, y_channel, center_x, center_y, width, height)
    def create_threshold_gate(self, name, channel, threshold, direction)
    def apply_gate(self, data, gate)
    def add_gate_to_plot(self, fig, gate, gate_index)
    def parse_polygon_coordinates(self, coordinates_str)

# advanced_gating.pyで完全実装・利用中
from utils.gating import GateManager
```

### 新機能の追加
- **新しいページ**: `pages/`ディレクトリに追加
- **カスタムプロット**: `utils/plotting.py`に新しい関数を追加
- **ゲーティング機能**: `utils/gating.py`で4種類のゲートタイプを完全実装済み
- **新しいゲートタイプ**: GateManagerクラスに新しいゲート作成メソッドを追加

### デバッグ
```python
import streamlit as st
st.write("Debug info:", variable)
st.json(data)
# セッション状態の確認
st.write("Session state:", st.session_state)
```

## 📋 対応ファイル形式
- **FCS 2.0/3.0/3.1**: 標準的なフローサイトメトリーファイル
- **チャンネル**: FSC-A/H/W、SSC-A/H/W、各種蛍光チャンネル
- **データ変換**: リニア、対数、asinh、biexponentialスケール

## 🔧 トラブルシューティング

### ライブラリ選択・互換性問題
- **fcsparser推奨**: 標準的なFCS形式に最適化されているため第一優先
- **NumPy 2.0問題**: fcsparserで"newbyteorder"エラー時は自動的にflowioにフォールバック
- **自動フォールバック**: ライブラリエラー時の自動代替選択機能

### ファイル読み込みエラー
- **ファイルサイズ**: 100MB制限を確認
- **FCS形式**: サポートされているバージョン（2.0/3.0/3.1）を確認
- **ファイル破損**: 他のソフトウェアでファイルが開けるかテスト
- **fcsparserエラー**: メタデータの形式やエンコーディングの問題を確認

### データ変換・処理エラー
- **array.array変換**: FlowIOでのarray.array→NumPy配列変換エラー
- **チャンネル名重複**: 自動リネーム機能による解決
- **メタデータ形式**: 異なるライブラリ間でのキー名の違いに自動対応
- **メモリ不足**: 最大イベント数を減らす、またはサンプリング数を調整
- **変換エラー**: 変換方法を"なし"に変更してテスト
- **チャンネル情報**: FCSファイルのメタデータとパラメータ設定を確認
- **データ型エラー**: 数値以外のデータが含まれていないか確認

### 表示問題
- **プロット表示**: ブラウザのJavaScript有効化を確認
- **日本語文字化け**: ブラウザの文字エンコーディング設定を確認
- **パフォーマンス**: サンプルサイズとビン数を調整

### デバッグ機能の活用
- **サイドバーデバッグ**: データ形状、変換プロセスの詳細表示
- **チャンネル確認**: 読み込まれたチャンネル名の詳細確認
- **メタデータ検証**: 全メタデータ項目の確認機能

### ゲーティング関連エラー
- **座標解析エラー**: ポリゴンゲートの座標形式を確認
- **ゲート適用失敗**: チャンネル名とデータ形式の整合性を確認
- **可視化エラー**: プロット表示とゲート描画の互換性を確認

### セッション管理
- **データ消失**: ブラウザのページ再読み込みでセッション状態がリセット
- **メモリリーク**: 大きなデータセット処理後はアプリケーション再起動を推奨

## 🚨 制限事項
- **ライブラリ依存**: 最適な動作にはfcsparserが推奨だが、NumPy 2.0環境ではflowioが安定
- **NumPy互換性**: fcsparserはNumPy 2.0で動作不安定な場合があり、自動フォールバック機能で対応
- **チャンネル名**: 特殊文字を含むチャンネル名で表示問題の可能性
- **メモリ使用量**: 大容量FCSファイルではメモリ制限に注意
- **同時ユーザー**: Streamlit Cloudでは同時アクセス数に制限
- **セッション永続化**: ブラウザセッション終了でデータは消失
- **ゲーティング機能**: 高度なゲーティング機能は完全実装済み。メインアプリでは基本機能のみ提供

## 📄 ライセンス
このプロジェクトは研究・教育目的で作成されています。商用利用については開発者にお問い合わせください。

## 🤝 コントリビューション
バグ報告や機能要望は、GitHubのIssuesでお知らせください。プルリクエストも歓迎します。

### 開発ガイドライン
- **コード品質**: PEP 8準拠
- **日本語対応**: UI要素の日本語化
- **エラーハンドリング**: 適切な例外処理とユーザーフィードバック
- **パフォーマンス**: 大容量データでのメモリ効率

## 📞 サポート
技術的な質問やサポートが必要な場合は、プロジェクトのメンテナーにお問い合わせください。

---
**Author**: ymmtshch  
**Repository**: [https://github.com/ymmtshch/FACSDataAnalysis](https://github.com/ymmtshch/FACSDataAnalysis)  
**Version**: 1.0.0  
**Last Updated**: 2024
