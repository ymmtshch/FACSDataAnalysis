# FACS Data Analysis
StreamlitベースのFACS（フローサイトメトリー）データ解析Webアプリケーション

## 📋 概要
FACS Data Analysisは、フローサイトメトリーデータ（FCSファイル）を解析するためのWebベースのアプリケーションです。研究者や技術者が直感的なインターフェースでデータを可視化・解析できるよう設計されています。日本語インターフェースを採用し、研究現場での使いやすさを重視しています。

## ✨ 主な機能

### データ処理
- **FCSファイル解析**: FCS 2.0、3.0、3.1形式の標準的なフローサイトメトリーファイルの読み込み
- **データ変換**: none、log、asinh、biexp（biexponential）変換に対応
- **イベント数制御**: パフォーマンス最適化のための最大イベント数設定（1,000～100,000）
- **リアルタイム処理**: アップロードから解析まで一連の流れをシームレスに実行

### ファイル情報表示
- **基本統計情報**: 総イベント数、パラメータ数、取得日時、使用機器情報
- **実験メタデータ**: 実験名、サンプルID、オペレーター、ソフトウェア情報
- **チャンネル詳細**: 各チャンネルの詳細情報と設定値
- **データプレビュー**: 最初の100行のデータ表示

### 可視化機能
- **ヒストグラム**: 
  - 任意チャンネルの分布表示
  - カスタマイズ可能なビン数（20～200）
  - 対数スケール表示オプション
- **散布図**: 
  - 2Dプロットでの相関解析
  - 透明度調整（0.1～1.0）
  - パフォーマンス最適化のためのサンプリング機能
- **等高線プロット**: 
  - 2Dヒストグラムベースの密度可視化
  - カスタマイズ可能な密度計算ビン数
  - 等高線ラベル表示

### ゲーティング機能
- **基本閾値ゲーティング**: 単一チャンネルでの閾値設定による簡易ゲーティング
- **ゲート統計**: ゲート前後のイベント数比較とゲート率計算
- **高度ゲーティング**: advanced_gating.pyページで詳細機能を提供（開発中）

### 統計解析・エクスポート
- **全チャンネル統計**: 平均値、中央値、標準偏差などの基本統計量
- **統計データエクスポート**: CSV形式での統計情報ダウンロード
- **生データエクスポート**: 処理済みデータのCSV出力

## 🔧 システム要件
- Python 3.8以上
- Streamlit 1.28.0以上
- モダンWebブラウザ（Chrome、Firefox、Safari、Edge）

## 📦 依存関係
```
streamlit>=1.28.0
pandas>=2.0.0
numpy>=1.24.0
plotly>=5.15.0
```

### ユーティリティモジュール（必須）
```
utils/
├── fcs_processor.py     # FCSファイル処理クラス
├── plotting.py          # プロット作成機能
└── gating.py           # ゲーティング機能（オプション）
```

## 🚀 インストールと実行

### ローカル環境での実行
1. **リポジトリのクローン**
   ```bash
   git clone https://github.com/ymmtshch/FACSDataAnalysis.git
   cd FACSDataAnalysis
   ```

2. **仮想環境の作成**
   ```bash
   python -m venv venv
   source venv/bin/activate  # Windows: venv\Scripts\activate
   ```

3. **依存関係のインストール**
   ```bash
   pip install -r requirements.txt
   ```

4. **アプリケーションの実行**
   ```bash
   streamlit run app.py
   ```

### Streamlit Cloudでのデプロイ
1. GitHubリポジトリにコードをプッシュ
2. [Streamlit Cloud](https://streamlit.io/cloud)にアクセス
3. リポジトリを選択してデプロイ

## 📁 プロジェクト構造
```
facs-analysis-app/
├── app.py                    # メインアプリケーション
├── config.py                 # 設定ファイル
├── requirements.txt          # 依存関係
├── README.md                 # プロジェクト説明
├── .gitignore               # Git除外設定
├── .streamlit/
│   └── config.toml          # Streamlit設定
├── pages/
│   └── advanced_gating.py   # 高度ゲーティングページ（オプション）
└── utils/
    ├── fcs_processor.py     # FCS処理ユーティリティ（必須）
    ├── plotting.py          # プロット作成機能（必須）
    └── gating.py            # ゲーティング機能（オプション）
```

## 📖 使用方法

### 1. ファイルアップロード
1. **ファイル選択**: 左サイドバーの「📁 ファイルアップロード」セクションでFCSファイルを選択
2. **処理オプション設定**:
   - **変換方法**: none、log、asinh、biexpから選択
   - **最大イベント数**: 1,000～100,000の範囲で設定
3. **処理実行**: 「📊 ファイルを処理」ボタンをクリック

### 2. データ解析インターフェース
アプリケーションは4つのタブで構成されています：

#### 📊 基本情報タブ
- **ファイル情報**: 総イベント数、パラメータ数、取得日時などの基本情報
- **実験情報**: 実験名、サンプルID、オペレーター情報
- **チャンネル情報**: 各チャンネルの詳細設定
- **データプレビュー**: 最初の100行のデータ表示

#### 📈 可視化タブ
- **ヒストグラム**: 
  - チャンネル選択とビン数調整
  - 対数スケール表示オプション
- **散布図**: 
  - X軸・Y軸チャンネル選択
  - 透明度とサンプルサイズ調整
- **等高線プロット**: 
  - 2Dヒストグラムの密度可視化
  - 密度計算ビン数の調整

#### 🎯 ゲーティングタブ
- **基本閾値ゲーティング**: 
  - ゲートチャンネル選択
  - 閾値設定（デフォルト：中央値）
  - ゲート前後の統計比較

#### 📋 統計解析タブ
- **全チャンネル統計**: 基本統計量の一覧表示
- **データエクスポート**: 
  - 統計データのCSVダウンロード
  - 生データのCSVダウンロード

### 3. 高度な機能
- **高度ゲーティング**: `advanced_gating.py`ページで複雑なゲーティング機能を提供
- **カスタム可視化**: Plotlyベースのインタラクティブなプロット

## ⚙️ 設定とカスタマイズ

### UI設定
アプリケーションのUIは以下の要素でカスタマイズされています：
- **カラーテーマ**: メインヘッダー（青）、セクションヘッダー（オレンジ）
- **レスポンシブデザイン**: ワイドレイアウトと拡張サイドバー
- **日本語インターフェース**: 完全日本語対応

### config.py設定
- アプリケーション固有の設定値
- デフォルトパラメータ
- ファイル処理制限

### .streamlit/config.toml
Streamlitアプリケーションの基本設定：
```toml
[server]
maxUploadSize = 100

[theme]
primaryColor = "#1f77b4"
backgroundColor = "#ffffff"
secondaryBackgroundColor = "#f0f2f6"
```

## 🔧 開発・拡張

### 必須ユーティリティモジュール
以下のモジュールは正常動作に必要です：

#### utils/fcs_processor.py
```python
class FCSProcessor:
    def get_file_info(self) -> dict
    def get_channel_info(self) -> dict
    def get_basic_stats(self) -> dict
    def export_data(self, data) -> str

def load_and_process_fcs(file, transformation, max_events):
    # FCSファイル処理の主要関数
    return processor, data, metadata
```

#### utils/plotting.py
```python
def create_histogram(data, channel, bins=50)
def create_scatter_plot(data, x_channel, y_channel, alpha=0.6)
```

### 新機能の追加
- **新しいページ**: `pages/`ディレクトリに追加
- **カスタムプロット**: `utils/plotting.py`に新しい関数を追加
- **ゲーティング機能**: `utils/gating.py`でゲートタイプを拡張

### デバッグ
```python
import streamlit as st
st.write("Debug info:", variable)
st.json(data)
# セッション状態の確認
st.write("Session state:", st.session_state)
```

## 📋 対応ファイル形式
- **FCS 2.0/3.0/3.1**: 標準的なフローサイトメトリーファイル
- **チャンネル**: FSC-A/H/W、SSC-A/H/W、各種蛍光チャンネル
- **データ変換**: リニア、対数、asinh、biexponentialスケール

## 🔧 トラブルシューティング

### ファイルアップロードエラー
- **ファイルサイズ**: 100MB制限を確認
- **FCS形式**: サポートされているバージョン（2.0/3.0/3.1）を確認
- **ファイル破損**: 他のソフトウェアでファイルが開けるかテスト

### 処理エラー
- **メモリ不足**: 最大イベント数を減らす
- **変換エラー**: 変換方法を"none"に変更してテスト
- **チャンネル情報**: FCSファイルのメタデータを確認

### 表示問題
- **プロット表示**: ブラウザのJavaScript有効化を確認
- **日本語文字化け**: ブラウザの文字エンコーディング設定を確認
- **パフォーマンス**: サンプルサイズとビン数を調整

### セッション管理
- **データ消失**: ブラウザのページ再読み込みでセッション状態がリセット
- **メモリリーク**: 大きなデータセット処理後はアプリケーション再起動を推奨

## 🚨 制限事項
- **メモリ使用量**: 大容量FCSファイルではメモリ制限に注意
- **同時ユーザー**: Streamlit Cloudでは同時アクセス数に制限
- **セッション永続化**: ブラウザセッション終了でデータは消失

## 📄 ライセンス
このプロジェクトは研究・教育目的で作成されています。商用利用については開発者にお問い合わせください。

## 🤝 コントリビューション
バグ報告や機能要望は、GitHubのIssuesでお知らせください。プルリクエストも歓迎します。

### 開発ガイドライン
- **コード品質**: PEP 8準拠
- **日本語対応**: UI要素の日本語化
- **エラーハンドリング**: 適切な例外処理とユーザーフィードバック
- **パフォーマンス**: 大容量データでのメモリ効率

## 📞 サポート
技術的な質問やサポートが必要な場合は、プロジェクトのメンテナーにお問い合わせください。

---
**Author**: ymmtshch  
**Repository**: [https://github.com/ymmtshch/FACSDataAnalysis](https://github.com/ymmtshch/FACSDataAnalysis)  
**Version**: 1.0.0  
**Last Updated**: 2024
